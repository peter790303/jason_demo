(function($){var winHeight=window.size().height,_moreArticleDiv=$("#stream-topic-more"),discoverStream=$(".discover-stream__list"),supportsPassive=false,isGetDiscoverStream=false,discoverStreamItems;(function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date;a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,"script","//www.google-analytics.com/analytics.js","ga");ga("create","UA-65168598-28","auto","discoverStream");ga("create","UA-65168598-33","auto","streamtopic");traceTopicTagClick();try{var opts=Object.defineProperty({},"passive",{get:function(){supportsPassive=true}});window.addEventListener("test",null,opts)}catch(e){}window.addEventListener("scroll",handleScrollToStream,supportsPassive?{passive:true}:false);function getDiscoverStream(){$.ajax({type:"GET",url:"https://api.pixnet.cc/topics/hot",data:{article_url:location.href}}).fail(function(){console.log("error: can not get more interesting stream")}).done(function(data){handleDiscoverStream(data)})}function handleDiscoverStream(data){function transferWithImageProxy(url,width,height){return"https://imageproxy.pimg.tw/zoomcrop?width="+width+"&height="+height+"&url="+encodeURIComponent(url)}if(data.error||!data.hot_topics||!data.hot_topics.length){return}var streamHtml="";for(var i=0;i<data.hot_topics.length;i++){var hotTopics=data.hot_topics[i];streamHtml+='<li class="discover-stream__item" data-group="group'+i+'" data-is-watched='+false+">"+'<a class="discover-stream__link" href="'+hotTopics.link+'">'+'<img class="discover-stream__topic-cover" src="'+transferWithImageProxy(hotTopics.topic_cover,600,225)+'">'+'<div class="discover-stream__topic-info">'+'<h3 class="discover-stream__topic-title">'+hotTopics.topic_name+"</h3>"+'<div class="discover-stream__topic-discussion-wrap">'+'<ul class="discover-stream__topic-user">'+handleStreamUser(data,i)+"</ul>"+'<div class="discover-stream__topic-discussion">'+addComas(hotTopics.posts_count)+" 則討論</div>"+"</div>"+"</div>"+"</a>"+"</li>"}discoverStream.append(streamHtml);bindDiscoverStreamClick();discoverStreamItems=document.querySelectorAll(".discover-stream__item")}function handleStreamUser(data,i){var user="";if(!data.hot_topics[i].members){return""}for(var j=0;j<data.hot_topics[i].members.length;j++){user+='<li class="discover-stream__topic__item"><img class="discover-stream__topic__user-avatar" src="'+data.hot_topics[i].members[j].avatar+'"></img></li>'}return user}function addComas(number){return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function judgeGetDiscoverStream(){if(isGetDiscoverStream){return}if(discoverStream[0].getBoundingClientRect().top<winHeight+600){isGetDiscoverStream=true;getDiscoverStream()}}function handleDiscoverStreamInView(){if(!discoverStreamItems||discoverStreamItems.length===0){return}for(var i=0;i<discoverStreamItems.length;i++){var ele=discoverStreamItems[i],eleRect=ele.getBoundingClientRect();isWatched=ele.dataset.isWatched==="true";if(eleRect.bottom>0&&eleRect.top<winHeight&&!isWatched){ele.dataset.isWatched="true";_piq.push(["trackEvent","band-interesting-group","imps-band-interesting-group",ele.dataset.group]);sendDiscoverStreamGAEvent({eventCategory:"band-interesting-group",eventAction:"imps-band-interesting-group",eventLabel:ele.dataset.group})}}if(discoverStreamItems[discoverStreamItems.length-1].dataset.isWatched==="true"){window.removeEventListener("scroll",handleScrollToStream)}}function handleScrollToStream(){judgeGetDiscoverStream();handleDiscoverStreamInView()}function bindDiscoverStreamClick(){var topics=document.querySelectorAll(".discover-stream__item"),watchMore=document.querySelector(".discover-stream__watch-more");watchMore.addEventListener("click",function(){_piq.push(["trackEvent","band-interesting-group","click-moreband","click-moreband"]);sendDiscoverStreamGAEvent({eventCategory:"band-interesting-group",eventAction:"click-moreband",eventLabel:"click-moreband"})});for(var i=0;i<topics.length;i++){var topicCover=topics[i].childNodes[0].childNodes[0],topicInfo=topics[i].childNodes[0].childNodes[1];topicCover.addEventListener("click",function(e){var group=e.currentTarget.parentNode.parentNode.dataset.group;_piq.push(["trackEvent","click-interestingStream-image","click",group]);sendDiscoverStreamGAEvent({eventCategory:"band-interesting-group",eventAction:"click-image",eventLabel:group})});topicInfo.addEventListener("click",function(e){var group=e.currentTarget.parentNode.parentNode.dataset.group;_piq.push(["trackEvent","click-interestingStream-groupname","click",group]);sendDiscoverStreamGAEvent({eventCategory:"band-interesting-group",eventAction:"click-groupname",eventLabel:group})})}}function sendDiscoverStreamGAEvent(trackEvent){ga("discoverStream.send","event",trackEvent)}function getText(){if(!window.getSelection){return""}return window.getSelection().toString().replace(/(\r\n|\n|\r)/gm,"")}function getPosition(){var rect=window.getSelection().getRangeAt(0).getBoundingClientRect();return{top:window.scrollY+rect.top-rect.height,left:(rect.left+rect.right)/2}}function reset(){_moreArticleDiv.hide()}function recordEvent(action,label){ga("streamtopic.send","event","streamtopic",action,label)}function traceTopicTagClick(){var desktopData=$(".article-head").children(".title").data(),mobileData=$(".article-header").children(".header-title").data(),articleCat=(desktopData||mobileData).siteCategory,_tagContainer=$(".tag-container");if(!_tagContainer.length){_tagContainer=$(".article-keyword")}_tagContainer.on("click",".topic",function(evt){var link=$(evt.target),index=link.index(),version=_tagContainer.data().version,action="文章標籤"+version+"-導流"+index,label="文章內頁-文章標籤"+version+"-"+articleCat;recordEvent(action,label)})}function bindSelectvent(){if(!_moreArticleDiv||!_moreArticleDiv.length){return}$.ajax({url:"https://streamtopic.pixnet.net/api/topics?token="+pix.jwtToken,type:"GET",cache:true}).then(function(data){var _moreArticleLink=_moreArticleDiv.children("a"),topicMapping={},i,topic;for(i=0;i<data.length;i++){topic=data[i];topicMapping[topic.name]=topic}document.addEventListener("selectionchange",function(){var text=getText(),topic=topicMapping[text];if(!text||text.length>10||!topic){reset();return}var pos=getPosition();_moreArticleLink.html(text).attr("href",topic.link);_moreArticleDiv.css(pos).show()});_moreArticleLink.on("click",function(){recordEvent("文章內容反灰","文章內頁-內容反灰")})})}})(jQuery);
