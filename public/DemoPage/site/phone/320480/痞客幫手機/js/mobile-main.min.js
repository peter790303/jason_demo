var pix=window.pix||{};pix.htmlspecialchars_decode=function(string,quote_style){if(null===string){return""}string=string.toString();string=string.replace(/&amp;/g,"&");string=string.replace(/&lt;/g,"<");string=string.replace(/&gt;/g,">");string=string.replace(/&quot;/g,'"');if(quote_style=="ENT_QUOTES"){string=string.replace(/&#039;/g,"'")}return string};pix.htmlspecialchars=function(str,quote_type){if(null===str){return""}str=str.toString();str=str.replace(/&/g,"&amp;");str=str.replace(/</g,"&lt;");str=str.replace(/>/g,"&gt;");str=str.replace(/"/g,"&quot;");if("ENT_QUOTES"==quote_type){str=str.replace(/'/g,"&#039;")}return str};(function($){"use strict";document.addEventListener("DOMContentLoaded",function(){var main={el:{$win:$(window),$body:$("body"),header_right_brn:$("#mixpanel-header-list"),colse_snap_drawer:$(".snap-drawer-bg, .snap-drawer-close-btn"),snap_drawers:$(".snap-drawers"),snap_drawer_bg:$(".snap-drawer-bg"),snap_drawer:$(".snap-drawer"),zoomIn:$(".zoom a.zoom-in"),zoomOut:$(".zoom a.zoom-out"),zoomBtns:$(".zoom-btn"),article:$(".article-content-inner"),quickNavsBtn:$(".quick-nav__btn"),quickNavsSlideshow:$(".quick-navs__main__slideshow"),commentBlock:$("#comment-block"),commentBlockBtn:$(".btn--toggle-comment"),commentCard:$("#comment-block__card"),commentCardBtn:$(".btn--open-comment-card"),commentAddBtn:$("#btn--add-comment"),goTopBtn:$("#footer-btn"),commentTextarea:document.querySelector("#add-comment-body"),needCheckImps:$("[data-ga-imps], [data-pa-imps], [data-analytic-imps]")},zoomClass:["zoom1","zoom2","zoom3"],zoomLevel:0,openExpPromptLoginPopup:false,init:function(){var _this=this;var renderBlogArticleList=function(ret){if(!$.fn.render){$.ajaxSetup({cache:true});$.getScript("//libs.pixfs.net/jsrender/jsrender.min.js").done(function(){_this.render(ret)})}else{_this.render(ret)}};this.el.article.removeClass("zoom1 zoom2 zoom3").addClass("zoom1");if(document.getElementById("article-list-with-category-tpl")){$.get("/blog/getarticlelistbycustomcategory",renderBlogArticleList)}this.bindEvent();this.resizeArticleIframes();this.loadCommentCardContent()},bindEvent:function(){this.el.$win.on("scroll",this.bind(this,this.scrollHandler,this.isSupportPassive()?{passive:true}:false));this.el.header_right_brn.on("click",this.bind(this,this.openRightPanel));this.el.colse_snap_drawer.on("click",this.bind(this,this.closeRightPanel));this.el.zoomIn.on("click",this.bind(this,this.zoomInClick));this.el.zoomOut.on("click",this.bind(this,this.zoomOutClick));this.el.$body.on("click",'a[data-type="blog-cateogy-folder"]',this.blogCategoryClick);this.el.zoomBtns.on("click",this.bind(this,this.zoomBtnsClick));this.el.quickNavsBtn.on("click",this.bind(this,this.quickNavsBtnClick));this.el.goTopBtn.on("click",this.bind(this,this.goTopBtnClick));this.el.commentBlockBtn.on("click",this.bind(this,this.commentBlockBtnClick));this.el.commentCardBtn.on("click",this.bind(this,this.commentCardBtnClick));this.el.commentAddBtn.on("click",this.bind(this,this.commentAddBtnClick));this.el.commentCard.find("#add-comment-name").on("keyup change",function(){var _this=$(this),name=_this.val()||"",isTooLong=name.replace(/[\u4E00-\u9FA5]/g,"aa").length>16;_this.parent().toggleClass("with-error",isTooLong)});this.el.commentCard.find(".comment-private__info").on("click",function(evt){$(this).addClass("active").off(evt)});this.el.commentCard.find(".login-with-comment").on("click",function(evt){evt.preventDefault();var link=$(this),commentCard=link.parents("#comment-block__card"),comment=commentCard.find("#add-comment-body").html().replace(/&nbsp;/g," ").replace(/<br(\/)?>/g,"\n").replace(/<div>/g,"\n").replace(/<\/div>/g,"").replace(/^\n/,""),doneUrl=buildUrl(location.href,{comment:"active",comment_body:pix.htmlspecialchars_decode(comment)}),loginDomain="//login.pixnet.cc"+commentCard.data("urlSuffix"),loginUrlWithComment=buildUrl(loginDomain,{theme:"mobile",done:doneUrl});location.href=loginUrlWithComment});this.el.$body.on("click","[data-ga-click]",this.recordGaEvent);this.el.$body.on("click","[data-pa-click]",this.recordPaEvent);this.el.$body.on("click","[data-analytic-click]",this.recordAnalyticEvent);if(!pix.member_token&&this.el.commentTextarea){this.el.commentTextarea.addEventListener("click",this.bind(this,this.showPromptLoginPopup))}if(!pix.is_owner){return}this.el.commentBlock.on("click",".comment__footer__btn--delete",this.bind(this,this.deleteComment));this.el.commentBlock.on("click",".comment__btn--toggle-reply",this.bind(this,this.toggleReplyComment));this.el.commentBlock.on("click",".comment__reply__btn--submit",this.bind(this,this.replyComment))},render:function(ret){if(ret.error){return}if(!$.fn.render){return}$("#article-list-with-category").html($("#article-list-with-category-tpl").render(ret));$("#side-menu-blog .menu-opitions-control,#nav-opitions.menu-opitions-control").collapse({open:function(){this.slideDown(100)},close:function(){this.slideUp(100)},accordion:true})},isSupportPassive:function(){var supportsPassive=false;try{var opts=Object.defineProperty({},"passive",{get:function(){supportsPassive=true}});window.addEventListener("test",null,opts)}catch(e){}return supportsPassive},recordGaEvent:function(){var ele=$(this),gaEventAttr=ele.data().gaClick,gaEventInfo=getEventInfo(gaEventAttr),dataLayer=window.dataLayer||[];if(!gaEventInfo){return}dataLayer.push(gaEventInfo);function getEventInfo(eventAttr){if(!eventAttr){return}var gaEventArr=eventAttr.split(",");if(gaEventArr.length<3){return}return{event:"mobile "+gaEventArr[0],eventCategory:gaEventArr[1]||"",eventAction:gaEventArr[2]||"",eventLabel:gaEventArr[3]||"",eventNonInteraction:0}}},recordPaEvent:function(){var ele=$(this),paEventAttr=ele.data().paClick,paEventInfo=getEventInfo(paEventAttr),dataLayer=window.dataLayer||[];if(!paEventInfo){return}_piq.push(["trackEvent",paEventInfo.cat,paEventInfo.act,paEventInfo.label]);function getEventInfo(eventAttr){if(!eventAttr){return}var paEventArr=eventAttr.split(",");if(paEventArr.length<2){return}return{cat:paEventArr[0],act:paEventArr[1],label:paEventArr[2]}}},recordAnalyticEvent:function(){var ele=$(this),analyticEventAttr=ele.data().analyticClick,analytic=getEventInfo(analyticEventAttr),dataLayer=window.dataLayer||[];if(!analytic){return}dataLayer.push(analytic);_piq.push(["trackEvent",analytic.eventCategory,analytic.eventAction,analytic.eventLabel]);function getEventInfo(eventAttr){if(!eventAttr){return}var analyticEventArr=eventAttr.split(",");if(analyticEventArr.length<3){return}return{event:"mobile "+analyticEventArr[0],eventCategory:analyticEventArr[1]||"",eventAction:analyticEventArr[2]||"",eventLabel:analyticEventArr[3]||"",eventNonInteraction:0}}},blogCategoryClick:function(){$(this).parents(".opition-items-group").toggleClass("open-child");$(this).parent().toggleClass("open");var blogCategoryFolderId=$(this).data("id");$("#"+blogCategoryFolderId).toggle()},openRightPanel:function(){this.el.$body.addClass("no-scroll");this.el.snap_drawers.addClass("show");this.el.snap_drawer_bg.addClass("show");this.el.snap_drawer.addClass("snap-drawer-right");var isAllCategoryName=this.el.header_right_brn[0].classList.contains("all-category");if(isAllCategoryName){_piq.push(["trackEvent","select-category","all-category"]);ga("create","UA-408650-33","auto","categoryTracker");ga("categoryTracker.send","event","select-category","all-category")}},closeRightPanel:function(e){this.el.$body.removeClass("no-scroll");this.el.snap_drawer_bg.removeClass("show");this.el.snap_drawer.removeClass("snap-drawer-right");var self=this;setTimeout(function(){self.el.snap_drawers.removeClass("show")},500)},resizeArticleIframes:function(){var maxWidth=window.size().width-2*20,articleContainer=this.el.article,iframesNeedCheckSize=articleContainer.find(".iframe--check-resize"),i,container,currentIframe,iframeSrc;for(i=0;i<iframesNeedCheckSize.length;i++){currentIframe=iframesNeedCheckSize.eq(i);if(currentIframe.width()<=maxWidth){continue}iframeSrc=currentIframe.attr("src").replace(/&width=(\d)*/g,"&width="+maxWidth).replace(/\?width=(\d)*/g,"?width="+maxWidth);currentIframe.attr("src",iframeSrc);setMaxSize(currentIframe);container=currentIframe.parent();while(!container.is(articleContainer)){setMaxSize(container);container=container.parent()}}function setMaxSize(ele){ele.css("max-width",maxWidth)}},sendTopbarTrackEvent:function(category,action,label){ga("gaMainTracker.send","event",{eventCategory:category,eventAction:action,eventLabel:label});_piq.push(["trackEvent",category,action,label])},zoomInClick:function(){if(this.zoomLevel<this.zoomClass.length-1){this.zoomLevel++;this.el.article.removeClass("zoom1 zoom2 zoom3").addClass(this.zoomClass[this.zoomLevel])}},zoomOutClick:function(){if(this.zoomLevel>0){this.zoomLevel--;this.el.article.removeClass("zoom1 zoom2 zoom3").addClass(this.zoomClass[this.zoomLevel])}},zoomBtnsClick:function(evt){var target=$(evt.target),zoomBtn=target.hasClass("zoom-btn")?target:target.parents(".zoom-btn"),fontsize=zoomBtn.data("fontsize");this.el.article.removeClass("zoom-sm zoom-md zoom-lg").addClass("zoom-"+fontsize);this.el.zoomBtns.removeClass("active");zoomBtn.addClass("active")},loadCommentCardContent:function(){var articleId,_headerTitle=this.el.$body.find(".header-title"),_this=this;if(!_headerTitle.length){return}articleId=_headerTitle.attr("id").replace("article-","");_this.getCommentAuthcodeImg();$.ajax({url:"/api/articlecomments?article_id="+articleId,method:"get"}).then(function(res){if(!res.comments||!res.comments.comments_list){return}_this.insertCommentList(res.comments)})},quickNavsBtnClick:function(evt){var total=this.el.quickNavsSlideshow.data("total"),translateX=this.el.quickNavsSlideshow.data("translateX")||0,direction=$(evt.target).index(".quick-nav__btn")||-1,moveto=getNextIdx(parseInt(translateX+direction));if(moveto===translateX){return}this.el.quickNavsSlideshow.data("translateX",moveto);this.el.quickNavsSlideshow.removeClass("slide-0 slide-1 slide-2 slide-3 slide-4 slide-5 slide-6 slide-7 slide-8 slide-9").addClass("slide-"+moveto);function getNextIdx(index){if(index<0){return 0}if(index>=total){return total-1}return index}},commentBlockBtnClick:function(){this.el.commentBlock.toggleClass("active")},showPromptLoginPopup:function(){if(!this.openExpPromptLoginPopup){window.pixgame.showPromptLoginPopup()}this.openExpPromptLoginPopup=true},commentCardBtnClick:function(){var loginText=this.el.commentCard.data("login"),shouldCardActive=!this.el.commentCard.hasClass("active");this.el.commentCard.toggleClass("active",shouldCardActive);if(shouldCardActive&&loginText){_piq.push(["trackEvent","comment-write","comment-write-"+loginText,"imps-"+loginText])}},commentAddBtnClick:function(){var commentCard=this.el.commentCard,nameInput=commentCard.find("#add-comment-name"),bodyArea=commentCard.find("#add-comment-body"),authCodeInput=commentCard.find("#add-comment-authcode"),privateCheckbox=commentCard.find("#comment-private"),name=nameInput.val()||"",body=bodyArea.val(),authCode=authCodeInput.val()||"",isPrivate=privateCheckbox.length?privateCheckbox.prop("checked"):true,isNameTooLong=name.replace(/[\u4E00-\u9FA5]/g,"aa").length>16,isBodyEmpty=body.length===0,isAuthCodeEmpty=authCodeInput.length&&(!authCode||authCode.length===0),_this=this,articleId=this.el.$body.find(".header-title").attr("id").replace("article-","");nameInput.parent().toggleClass("with-error",isNameTooLong);bodyArea.toggleClass("comment-block__textarea--error",isBodyEmpty);authCodeInput.parent().toggleClass("with-error",isAuthCodeEmpty);if(isBodyEmpty){_piq.push(["trackEvent","comment-result","result-no-word"])}if(isNameTooLong||isBodyEmpty||isAuthCodeEmpty){return}$.ajax({url:"/api/articlecomments?article_id="+articleId,method:"post",data:JSON.stringify({sToken:pix.sToken,authCode:authCode,body:pix.htmlspecialchars_decode(body),name:name,is_hidden:isPrivate})}).then(function(res){_this.getCommentAuthcodeImg();if(res.error_column==="authCode"){_piq.push(["trackEvent","comment-result","result-code-fail"]);authCodeInput.val("").attr("placeholder",res.message).parent().addClass("with-error");return}if(res.error){alert(res.message);return}_piq.push(["trackEvent","comment-result","result-success"]);nameInput.val("訪客").parent().removeClass("with-error");bodyArea.val("").removeClass("comment-block__textarea--error");authCodeInput.val("").parent().removeClass("with-error");var commentContainer=_this.el.commentBlock.find(".comment-block__main");_this.insertCommentList({comments_list:[res.comments]},true);commentContainer.scrollTop(commentContainer.children(".comment-list").height());_this.el.commentCard.addClass("showing-msg").delay(2e3).queue(function(next){_this.el.commentCard.removeClass("active");next()}).delay(800).queue(function(next){commentContainer.find(".comment--hide-left").removeClass("comment--hide-left");_this.el.commentCard.removeClass("showing-msg");next()})})},bind:function(obj,method){return function(){return method.apply(obj,[].slice.call(arguments))}},scrollHandler:function(){this.checkElementImps()},checkElementImps:function(){this.el.needCheckImps=$("[data-ga-imps], [data-pa-imps], [data-analytic-imps]").not("[data-need-analytic = undefined]");var i,ele,isInView,eventInfo,gaEventInfo,paEventInfo,eles=this.el.needCheckImps;for(i=0;i<eles.length;i++){ele=eles[i];isInView=checkIfInView(ele);if(""+isInView===ele.dataset.isInView){continue}ele.dataset.isInView=isInView;if(!isInView){return}if(ele.dataset.gaImps){eventInfo=getGAEventInfo(ele.dataset.gaImps);eventInfo&&dataLayer.push(eventInfo)}if(ele.dataset.paImps){paEventInfo=getPAEventInfo(ele.dataset.paImps);_piq.push(["trackEvent",paEventInfo.cat,paEventInfo.act,paEventInfo.label])}if(ele.dataset.analyticImps){gaEventInfo=getAnalyticEventInfo(ele.dataset.analyticImps);gaEventInfo&&dataLayer.push(gaEventInfo);paEventInfo=getAnalyticEventInfo(ele.dataset.analyticImps);_piq.push(["trackEvent",paEventInfo.eventCategory,paEventInfo.eventAction,paEventInfo.eventLabel])}if(ele.dataset.analyticOnce){ele.dataset.needAnalytic=undefined}}function checkIfInView(ele){if(!ele){return}var winHeight=window.size().height,eleRect=ele.getBoundingClientRect();return eleRect.bottom>0&&eleRect.top<winHeight}function getPAEventInfo(eventAttr){if(!eventAttr){return}var paEventArr=eventAttr.split(",");if(paEventArr.length<2){return}else if(paEventArr.length>3){paEventArr.shift()}return{cat:paEventArr[0],act:paEventArr[1],label:paEventArr[2]}}function getGAEventInfo(eventAttr){if(!eventAttr){return}var gaEventArr=eventAttr.split(",");if(gaEventArr.length<3){return}return{event:"mobile "+gaEventArr[0],eventCategory:gaEventArr[1],eventAction:gaEventArr[2],eventLabel:gaEventArr[3],eventNonInteraction:1}}function getAnalyticEventInfo(eventAttr){if(!eventAttr){return}var gaEventArr=eventAttr.split(",");if(gaEventArr.length<3){return}return{event:"mobile "+gaEventArr[0],eventCategory:gaEventArr[1]||"",eventAction:gaEventArr[2]||"",eventLabel:gaEventArr[3]||"",eventNonInteraction:1}}},goTopBtnClick:function(){this.el.$body.animate({scrollTop:0},1e3);$("html").animate({scrollTop:0},1e3)},toggleReplyComment:function(evt){var thisComment=$(evt.target).parents(".comment"),shouldReplyBlockExist=!thisComment.hasClass("replying"),cancelBtn='<button class="comment__btn-action comment__btn--toggle-reply">取消</button>',submitBtn='<button class="comment__btn-action comment__btn-action--blue comment__reply__btn--submit">送出</button>',footer="<div>"+cancelBtn+submitBtn+"</div>";thisComment.toggleClass("replying",shouldReplyBlockExist).find(".comment__reply-block").remove();if(shouldReplyBlockExist){_piq.push(["trackEvent","comment-list","click-from-author","click-author-recomment"]);thisComment.append($('<div class="comment__reply-block"><textarea />'+footer+"</div>"))}else{_piq.push(["trackEvent","comment-list","click-from-author","click-author-cancel"])}},deleteComment:function(evt){_piq.push(["trackEvent","comment-list","click-from-author","click-author-delete"]);var thisComment=$(evt.target).parents(".comment"),articleId=this.el.$body.find(".header-title").attr("id").replace("article-",""),commentId=thisComment.data("id");$.ajax({url:"/api/articlecomments?article_id="+articleId+"&comment_id="+commentId,method:"delete",data:JSON.stringify({sToken:pix.sToken})}).then(function(res){if(res.error){alert(res.message);return}thisComment.remove()})},replyComment:function(evt){_piq.push(["trackEvent","comment-list","click-from-author","click-author-send"]);var replyBlock=$(evt.target).parents(".comment__reply-block"),commentBlock=replyBlock.parents(".comment"),articleId=this.el.$body.find(".header-title").attr("id").replace("article-",""),commentId=commentBlock.data("id"),replyContent=replyBlock.find("textarea").val();$.ajax({url:"/api/replyarticlecomment?article_id="+articleId+"&comment_id="+commentId,method:"post",data:JSON.stringify({sToken:pix.sToken,body:pix.htmlspecialchars_decode(replyContent)})}).then(function(res){if(res.error){alert(res.message);return}replyBlock.remove();commentBlock.find(".comment__footer__btn").remove();commentBlock.removeClass("replying").append(getBloggerReply(res.comments,res.comments))})},getCommentAuthcodeImg:function(){var authcodeContainer=this.el.commentCard.find(".comment-block__authcode-container"),articleId=this.el.$body.find(".header-title").attr("id").replace("article-","");if(!authcodeContainer.length){return}$.ajax({url:"/api/getcommentauthcode?article_id="+articleId,method:"get"}).then(function(res){if(!res.auth_code){authcodeContainer.remove();return}authcodeContainer.find("img").remove();$("<img>").attr("alt","驗證碼圖片").attr("src",res.auth_code).appendTo(authcodeContainer)})},insertCommentList:function(commentInfo,needAnimate){var i,comment,commentListContent="",liClasses=needAnimate?"comment comment--hide-left":"comment",bloggerInfo={name:commentInfo.name,avatar:commentInfo.avatar,link:commentInfo.link},commentList=commentInfo.comments_list,commentListEle=this.el.commentBlock.find(".comment-list");pix.owner_name=commentInfo.name;if(!commentList.length){return}for(var i=0;i<commentList.length;i++){comment=commentList[i];commentListContent+='<li class="'+liClasses+'" data-id="'+comment.id+'">'+getVisitorComment(comment)+getBloggerReply(comment,bloggerInfo)+"</li>"}if(commentListEle.length){commentListEle.append($(commentListContent));return}this.el.commentBlock.find(".comment-block__main").eq(0).empty().removeClass("comment-block__main--no-message").append('<ul class="comment-list"></ul>').append($(commentListContent))}};main.init()});function getVisitorComment(comment){if(comment.is_hidden&&!comment.body){return'<div class="comment__visitor"><div class="comment__header"><div class="comment__avatar comment__avatar--lock"></div><span class="comment--gray">悄悄話留言</span></div></div>'}var header=getHeader(comment),bubble=getBubble(comment.body||" "),time=getFooter(comment,false);return'<div class="comment__visitor">'+header+'<div class="comment__main">'+bubble+time+"</div></div>"}function getBloggerReply(comment,bloggerInfo){if(!comment.has_reply){return""}if(!comment.reply||!comment.reply.body){return'<div class="comment__blogger"><div class="comment__header comment__header--right"><span class="comment--gray">版主 悄悄話回覆</span><div class="comment__avatar comment__avatar--lock"></div></div></div>'}var reply=comment.reply,header=getHeader(reply,bloggerInfo),bubble=getBubble(reply.body),time=getFooter(reply,true);return'<div class="comment__blogger">'+header+'<div class="comment__main">'+bubble+time+"</div></div>"}function getHeader(obj,bloggerInfo){var link=bloggerInfo?bloggerInfo.profile:obj.profile,name=bloggerInfo?"版主 "+pix.htmlspecialchars(pix.owner_name):pix.htmlspecialchars(obj.name),avatar=bloggerInfo?bloggerInfo.avatar:obj.avatar,nameEle=link?'<a class="comment__name" href="'+link+'">'+name+"</a>":'<a class="comment__name">'+name+"</a>",imgEle='<img class="comment__avatar" src="'+avatar+'" onerror="this.src=\'//s.pixfs.net/blog/images/choc/avatar-neutral.png\'" />',lockIcon=obj.is_hidden?'<span class="comment__icon--lock"></span>':"";if(bloggerInfo){return'<div class="comment__header">'+nameEle+imgEle+"</div>"}return'<div class="comment__header">'+imgEle+nameEle+lockIcon+"</div>"}function getBubble(content){return'<div class="comment__bubble">'+content+"</div>"}function getFooter(comment,isBlogger){var timestamp=comment.date,dayObj=new Date(Number.parseInt(timestamp)*1e3);if(!dayObj.getTime()){return""}var yyyy=dayObj.getFullYear(),MM=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][dayObj.getMonth()],dd=dayObj.getDate(),h=dayObj.getHours(),m=dayObj.getMinutes();if(dd<10){dd="0"+dd}if(h<10){h="0"+h}if(m<10){m="0"+m}var showActionBtn=!isBlogger&&!comment.has_reply&&pix.is_owner,deleteBtn=showActionBtn?'<button class="comment__footer__btn comment__footer__btn--delete">刪除</button>':"",replyBtn=showActionBtn?'<button class="comment__footer__btn comment__footer__btn--reply comment__btn--toggle-reply">回覆</button>':"";return'<div class="comment__footer">'+deleteBtn+replyBtn+"<time>"+[MM,dd,yyyy,h+":"+m].join(" ")+"</time></div>"}function buildUrl(orgUrl,params){var urlWithoutHash=orgUrl.split("#")[0],conjunction=urlWithoutHash.indexOf("?")>-1?"&":"?";return urlWithoutHash+conjunction+$.param(params)}})(jQuery);
